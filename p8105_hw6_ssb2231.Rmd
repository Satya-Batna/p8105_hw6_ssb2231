---
title: "P8105 Homework 6"
author: "Satya Batna"
output: 
  github_document:
    toc: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 7,
  fig.height = 5,
  out.width = "80%"
)

library(tidyverse)
library(broom)
library(purrr)
library(modelr)
library(p8105.datasets)

```

#Problem 1
```{r problem1-load}
homicide_raw = read_csv("data/homicide-data.csv")
```
 
```{r problem1-clean}
homicide_df =
  homicide_raw |>
  mutate(
    city_state = str_c(city, state, sep = ", "),
    
      resolved = case_when(
      disposition == "Closed by arrest" ~ 1,
      TRUE ~ 0
    ),
    resolved = factor(resolved),
    
    victim_race = str_to_lower(victim_race),
        victim_age = as.numeric(victim_age)
  ) |>
  filter(
    !city_state %in% c("Dallas, TX",
                       "Phoenix, AZ",
                       "Kansas City, MO",
                       "Tulsa, AL")
  ) |>
  filter(victim_race %in% c("white", "black"))

homicide_df
```

```{r problem1-baltimore-fit}
# Filter to Baltimore only
baltimore_df =
  homicide_df |>
  filter(city_state == "Baltimore, MD")

# Logistic regression: resolved vs unresolved
baltimore_fit =
  glm(
    resolved ~ victim_age + victim_sex + victim_race,
    data = baltimore_df,
    family = binomial()
  )

summary(baltimore_fit)

baltimore_tidy =
  tidy(baltimore_fit, conf.int = TRUE, exponentiate = TRUE)

baltimore_tidy
```


```{r problem1-all-cities}
city_or =
  homicide_df |>
  nest(data = -city_state) |>
  mutate(
    fit = map(
      data,
      ~ glm(
          resolved ~ victim_age + victim_sex + victim_race,
          data = .x,
          family = binomial()
        )
    ),
    results = map(
      fit,
      ~ tidy(.x, conf.int = TRUE, exponentiate = TRUE)
    )
  ) |>
  select(city_state, results) |>
  unnest(results) |>
  filter(term == "victim_sexMale") |>
  select(city_state, estimate, conf.low, conf.high)

city_or

# reorder cities by OR
city_or_plot =
  city_or |>
  mutate(city_state = forcats::fct_reorder(city_state, estimate))

# make the plot
city_or_plot |>
  ggplot(aes(x = estimate, y = city_state)) +
  geom_point() +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    x = "Adjusted odds ratio (Male vs Female)",
    y = "City",
    title = "OR for homicide being solved (Male vs Female victims) by city"
  )
```
The Washington Post articles discussed how half of murders going unsolved in the US. In this analysis, we see that most cities show adjusted odds ratios below 1, indicating that homicides with male victims are less likely to be solved than those with female victims after adjusting for age and race. Cities such as Baltimore show particularly low odds of resolving cases involving male victims, which are consistent with the findings of the article. Overall, these results suggest significant sex-based disparities in justice outcomes across U.S. cities.



```{r}

# Load data
data("weather_df")

# Function to compute R^2 and beta1*beta2
fit_one_boot = function(df) {
  fit = lm(tmax ~ tmin + prcp, data = df)

  r2 = glance(fit)$r.squared

  coefs = tidy(fit)
  beta1 = coefs |> filter(term == "tmin") |> pull(estimate)
  beta2 = coefs |> filter(term == "prcp") |> pull(estimate)

  tibble(
    r2 = r2,
    beta1_beta2 = beta1 * beta2
  )
}

# 5000 bootstrap samples
set.seed(123)
boot_results =
  weather_df |>
  bootstrap(n = 5000) |>
  mutate(est = map(strap, fit_one_boot)) |>
  select(-strap) |>
  unnest(est)

# Plot R^2 distribution
boot_results |>
  ggplot(aes(x = r2)) +
  geom_histogram(bins = 30) +
  labs(
    title = expression("Bootstrap Distribution of " ~ R^2),
    x = expression(R^2),
    y = "Count"
  )

# Plot beta1*beta2 distribution
boot_results |>
  ggplot(aes(x = beta1_beta2)) +
  geom_histogram(bins = 30) +
  labs(
    title = expression("Bootstrap Distribution of " ~ beta[1] %*% beta[2]),
    x = expression(beta[1] %*% beta[2]),
    y = "Count"
  )

# 95% CI for R^2 and beta1*beta2
ci_r2 =
  boot_results |>
  summarize(
    low = quantile(r2, 0.025),
    high = quantile(r2, 0.975)
  )

ci_beta =
  boot_results |>
  summarize(
    low = quantile(beta1_beta2, 0.025),
    high = quantile(beta1_beta2, 0.975)
  )

ci_r2
ci_beta

```
